VAULT_CHECKSUM_1_13_2_darwin_amd64 = 5b9f1da25ba26b90d98bb0f04a1ff930d09389d7b769d295dd2666dbb616fcd3
VAULT_CHECKSUM_1_13_2_darwin_arm64 = c8b8a395f3f6cfa07023619c22b3d1809827772bf61b692039e89eb5447eb406
VAULT_CHECKSUM_1_13_2_freebsd_386 = 60ebd4d75784f77d7d335420d4ed5eb653f2549c668c40ca0d4b3e7c047a66a3
VAULT_CHECKSUM_1_13_2_freebsd_amd64 = 8dfa7572d1f5e7118b021012a8d578d84e973d68b0db85611404719d0e4801c8
VAULT_CHECKSUM_1_13_2_freebsd_arm = af300b63a8a4fec036de7ba4f9905a7d71fe5dc34a0c94450e0160e48e0531e7
VAULT_CHECKSUM_1_13_2_linux_386 = d3a912d77eeb48aa0d01c507d1972525c4bccc82ae65cfe86d7688af28c178ae
VAULT_CHECKSUM_1_13_2_linux_amd64 = f7930279de8381de7c532164b4a4408895d9606c0d24e2e9d2f9acb5dfe99b3c
VAULT_CHECKSUM_1_13_2_linux_arm = e6120caa7c3fcce6be6c43f9ca24cbbb75960e9128070f8a6ddf23b6b8747088
VAULT_CHECKSUM_1_13_2_linux_arm64 = 5f72b0cbfd857a4f70ae06978260d56b50b36b478a3b68a158dc49d854de290d
VAULT_CHECKSUM_1_13_2_netbsd_386 = 99885cc8a02c755c3daac529bca1ab32ed5692ebd992c01d764fc308bfa433c9
VAULT_CHECKSUM_1_13_2_netbsd_amd64 = 1e194bf560d547a08ba8624f434f7ba967eb71d2ac48771afb848e8ba5128070
VAULT_CHECKSUM_1_13_2_netbsd_arm = 447582a824bc5c98d5f8e8413deda2c56658cdc8354de39e63d1bc34a6625f15
VAULT_CHECKSUM_1_13_2_openbsd_386 = ca51c7afc1b007dfc375c48f7113fa19a0925f3ac74710ee90844e516694c8a5
VAULT_CHECKSUM_1_13_2_openbsd_amd64 = 1e717b513bb91a58bc8567db891ff462698a9e41c17d1e456f820def8e1341c4
VAULT_CHECKSUM_1_13_2_openbsd_arm = 962f8c877b748356f7ba2a676a053882910d7bbbdb9da9927adab0e43c7ad3b7
VAULT_CHECKSUM_1_13_2_solaris_amd64 = 68bba0bd2a36b2dfc0fb8bb8d4ccbf4d8574fe3b1af2a2601fe0a2a901ccb34d
VAULT_CHECKSUM_1_13_2_windows_386 = 8d4402b08c5e8192fbea588d96be8a756ff3673fd842d8300c063566a2bc07d3
VAULT_CHECKSUM_1_13_2_windows_amd64 = cea43c98bc99dee55068b0095d06a4996b25392e89d5dccca3daec7075780668

VAULT_VERSION = 1.13.2
VAULT_ARCH = $(shell  go env GOARCH)
VAULT_OS = $(shell go env GOOS)

ifeq ($(OS),Windows_NT)
	VAULT_BINARY=vault.exe
else
	VAULT_BINARY=vault
endif

ENVTEST_ASSETS_DIR = $(shell pwd)/testbin
VAULT_CHECKSUM := $(VAULT_CHECKSUM_$(shell echo '$(VAULT_VERSION)' | sed 's/\./_/g')_$(VAULT_OS)_$(VAULT_ARCH))
VAULT_ARTIFACT_ID = $(VAULT_VERSION)-$(VAULT_OS)-$(VAULT_ARCH)-$(VAULT_CHECKSUM)
export TEST_VAULT_BINARY_PATH = $(ENVTEST_ASSETS_DIR)/bin/$(VAULT_BINARY)

vault_test_setup:
	@mkdir -p "$(ENVTEST_ASSETS_DIR)/archives"
	@mkdir -p "$(ENVTEST_ASSETS_DIR)/versions"
	@mkdir -p "$(ENVTEST_ASSETS_DIR)/bin"
	@test -f "$(ENVTEST_ASSETS_DIR)/archives/vault-$(VAULT_ARTIFACT_ID).zip" || curl -fLo "$(ENVTEST_ASSETS_DIR)/archives/vault-$(VAULT_ARTIFACT_ID).zip" "https://releases.hashicorp.com/vault/$(VAULT_VERSION)/vault_$(VAULT_VERSION)_$(VAULT_OS)_$(VAULT_ARCH).zip"
	@echo "$(VAULT_CHECKSUM)  $(ENVTEST_ASSETS_DIR)/archives/vault-$(VAULT_ARTIFACT_ID).zip" | sha256sum -c
	@test -f "$(ENVTEST_ASSETS_DIR)/versions/vault-$(VAULT_ARTIFACT_ID)" || bash -c 'temp="$$(mktemp -d)" && unzip "$(ENVTEST_ASSETS_DIR)/archives/vault-$(VAULT_ARTIFACT_ID).zip" -d "$${temp}" && mv "$${temp}/$(VAULT_BINARY)" "$(ENVTEST_ASSETS_DIR)/versions/vault-$(VAULT_ARTIFACT_ID)"'
	@ln -f -s "$(ENVTEST_ASSETS_DIR)/versions/vault-$(VAULT_ARTIFACT_ID)" "$(ENVTEST_ASSETS_DIR)/bin/$(VAULT_BINARY)"
	@echo "# Vault Binary (Version $(VAULT_VERSION)) ready at path: $(ENVTEST_ASSETS_DIR)/bin/$(VAULT_BINARY)"
